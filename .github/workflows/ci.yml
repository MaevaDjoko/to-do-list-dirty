name: CI

on:
  push:
    branches:
      - main
      - dev-quality-system
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest

    services:
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444

    steps:
      # 1ï¸âƒ£ Checkout
      - uses: actions/checkout@v3

      # 2ï¸âƒ£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager flake8 requests PyYAML

      # 4ï¸âƒ£ Linter
      - name: Run Linter
        run: |
          pip install flake8
          flake8 ./tasks/templates/tasks/ --max-line-length=120

      # 5ï¸âƒ£ Apply migrations and start Django server
      - name: Start Django server
        run: |
          pip install django
          python manage.py migrate
          python manage.py runserver 127.0.0.1:8000 &
          sleep 5

      # 6ï¸âƒ£ Tests Django (unitaires)
      - name: Run Django unit tests
        run: |
          python manage.py test --verbosity=2
          python manage.py test --testrunner=django.test.runner.DiscoverRunner --json > result_test_auto.json || true

      - name: Install Chrome
        run: sudo apt-get update && sudo apt-get install -y google-chrome-stable

      - name: Install Chromedriver
        run: sudo apt-get install -y chromium-chromedriver

      # 7ï¸âƒ£ Tests Selenium
      - name: Run Selenium E2E tests
        run: |
          pip install selenium
          python manage.py test tasks.templates.tasks.test_e2e_selenium.py --verbosity=2
          # JSON gÃ©nÃ©rÃ© : result_test_selenium.json

      # 8ï¸âƒ£ Tests d'accessibilitÃ©

      # 9ï¸âƒ£ GÃ©nÃ©rer le rapport global
      - name: Generate test report
        id: test_report
        run: |
          python test_report.py > full_report.txt
          cat full_report.txt

      # ðŸ”Ÿ Comment PR avec le rapport
      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### RÃ©sultat de la CI
            ```
            $(cat full_report.txt)
            ```
